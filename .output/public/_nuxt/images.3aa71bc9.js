import be from"./menubar.esm.0eb4abc5.js";import xe from"./inputnumber.esm.ac77af66.js";import ke from"./column.esm.2eb3cecb.js";import ce from"./tag.esm.ba7bd9e1.js";import{a as $e,_ as Ce}from"./UseSocialPost.vue.1ec7d063.js";import ue from"./calendar.esm.80e2d687.js";import de from"./checkbox.esm.49a34126.js";import Se from"./tristatecheckbox.esm.f82519cb.js";import fe from"./button.esm.4cfb2234.js";import Ve from"./datatable.esm.8de18a27.js";import Ie from"./toast.esm.f4f4a740.js";import De from"./confirmdialog.esm.35d539de.js";import Ee from"./dynamicdialog.esm.c255c087.js";import{g as ae,H as me,I as Ae,r as U,J as le,K as q,L as pe,x as Ue,M as se,N as Le,O as Te,P as Ne,D as _e,Q as Oe,o as T,c as M,a as m,b as s,R as K,u as t,z as F,t as A,w as h,d as he,F as je,i as Fe,j as qe,n as Me,s as ve,p as We,f as Be,_ as ze,A as Ke,B as Pe,C as Qe,E as te,G as re,l as Re}from"./entry.e65a8b12.js";import{u as ge}from"./fetch.67514f53.js";import{f as R,u as He,s as P}from"./index.ca906294.js";import Xe from"./autocomplete.esm.f423baf0.js";import Ye from"./chips.esm.d05f38cf.js";import{u as Ge,t as Je,c as ne,a as Ze,b as ie,d as et,e as tt,f as ot,_ as at}from"./NewAuthor.vue.44b81c2c.js";import"./index.esm.92dc1bc2.js";import"./baseicon.esm.727e0a4e.js";import"./index.esm.4ca4af39.js";import"./index.esm.6ffad009.js";import"./index.esm.08a63c45.js";import"./inputtext.esm.6f13cc8a.js";import"./overlaypanel.esm.c86d5ed9.js";import"./index.esm.42b2c471.js";import"./overlayeventbus.esm.5f1005ca.js";import"./portal.esm.aa40dffd.js";import"./index.esm.f6d9606f.js";import"./index.esm.98e3ba1b.js";import"./index.esm.ba2c5980.js";import"./index.esm.e6a916e6.js";import"./index.esm.4b125a15.js";import"./badge.esm.63629650.js";import"./index.esm.2a477ad8.js";import"./paginator.esm.1b688027.js";import"./index.esm.b3e830a1.js";import"./dropdown.esm.1ffad83e.js";import"./virtualscroller.esm.5359c919.js";import"./index.esm.cd5b4d12.js";import"./index.esm.0501af64.js";import"./index.esm.20c9b6e4.js";import"./index.esm.6f348039.js";import"./dialog.esm.99eb5595.js";function lt(e){var a;const o=q(e);return(a=o==null?void 0:o.$el)!=null?a:o}const st=Ne?window:void 0;function rt(...e){let a,o,l,v;if(typeof e[0]=="string"||Array.isArray(e[0])?([o,l,v]=e,a=st):[a,o,l,v]=e,!a)return Le;Array.isArray(o)||(o=[o]),Array.isArray(l)||(l=[l]);const p=[],$=()=>{p.forEach(_=>_()),p.length=0},i=(_,x,C,g)=>(_.addEventListener(x,C,g),()=>_.removeEventListener(x,C,g)),r=le(()=>[lt(a),q(v)],([_,x])=>{if($(),!_)return;const C=Te(x)?{...x}:x;p.push(...o.flatMap(g=>l.map(L=>i(_,g,L,C))))},{immediate:!0,flush:"post"}),b=()=>{r(),$()};return pe(b),b}function oe(e){return typeof Window<"u"&&e instanceof Window?e.document.documentElement:typeof Document<"u"&&e instanceof Document?e.documentElement:e}const nt=ae({name:"UseObjectUrl",props:["object"],setup(e,{slots:a}){const o=me(e,"object"),l=Ae(o);return()=>{if(a.default&&l.value)return a.default(l)}}});function we(e){const a=window.getComputedStyle(e);if(a.overflowX==="scroll"||a.overflowY==="scroll"||a.overflowX==="auto"&&e.clientWidth<e.scrollWidth||a.overflowY==="auto"&&e.clientHeight<e.scrollHeight)return!0;{const o=e.parentNode;return!o||o.tagName==="BODY"?!1:we(o)}}function it(e){const a=e||window.event,o=a.target;return we(o)?!1:a.touches.length>1?!0:(a.preventDefault&&a.preventDefault(),!1)}const Q=new WeakMap;function ct(e,a=!1){const o=U(a);let l=null,v;le(me(e),i=>{const r=oe(q(i));if(r){const b=r;Q.get(b)||Q.set(b,v),o.value&&(b.style.overflow="hidden")}},{immediate:!0});const p=()=>{const i=oe(q(e));!i||o.value||(se&&(l=rt(i,"touchmove",r=>{it(r)},{passive:!1})),i.style.overflow="hidden",o.value=!0)},$=()=>{var i;const r=oe(q(e));!r||!o.value||(se&&(l==null||l()),r.style.overflow=(i=Q.get(r))!=null?i:"",Q.delete(r),o.value=!1)};return pe($),Ue({get(){return o.value},set(i){i?p():$()}})}function ut(){let e=!1;const a=U(!1);return(o,l)=>{if(a.value=l.value,e)return;e=!0;const v=ct(o,l.value);le(a,p=>v.value=p)}}ut();const H=e=>(We("data-v-1bd36ffc"),e=e(),Be(),e),dt={class:"flex flex:col gap:4"},ft=H(()=>m("label",{for:"date",class:"f:bold"},"选择日期",-1)),mt={class:"p-error"},pt={class:"flex flex:col gap:4"},_t=H(()=>m("label",{for:"author",class:"f:bold"},"选择作者",-1)),ht={class:"flex flex:row gap:4 w:full"},vt={class:"p-error"},gt={class:"flex flex:col gap:4"},wt=H(()=>m("label",{for:"urls",class:"f:bold"},"原址链接",-1)),yt={class:"flex flex:row align-items:center gap:4"},bt=["src"],xt={class:"p-error"},kt={class:"flex flex:col gap:4"},$t=H(()=>m("label",{for:"nsfw",class:"f:bold"},"是否为NSFW",-1)),Ct={class:"p-error"},St={class:"flex flex:col gap:4"},Vt={key:0,class:"w:full h:150 py:8 flex flex:row gap:8 overflow-x:auto"},It={class:"rel w:full h:full bg:#00000020 ~opacity|200ms image-actions"},Dt={class:"p-error"},Et=ae({__name:"NewImageItem",setup(e){const a=_e(),o=Oe("dialogRef"),{data:l,pending:v,error:p,execute:$}=ge("/api/authors/all",{server:!1},"$h2i8gIzjKw"),{errors:i,defineField:r,handleSubmit:b}=Ge({validationSchema:Je(ne({date:Ze().required().default(new Date),author:ne().required(),urls:ie().of(et().url()).default([]),nsfw:tt().required().default(!1),images:ie().of(ot()).default([])}))}),[_,x]=r("date"),[C,g]=r("author"),[L,X]=r("urls"),[N,Y]=r("nsfw"),[S,n]=r("images"),D=U([]),O=U(!1);function G(d){l.value&&(d.query.trim().length?D.value=l.value.items.filter(u=>u.name.toLowerCase().includes(d.query.toLowerCase())):D.value=[...l.value.items])}function V(){let d=document.createElement("input");d.type="file",d.accept="image/*",d.multiple=!0,d.onchange=u=>{var k;const I=(k=u==null?void 0:u.target)==null?void 0:k.files;I&&(S.value=[...S.value??[],...I])},d.click()}function J(d){var u;S.value=(u=S.value)==null?void 0:u.filter((I,k)=>k!==d)}const W=b(async d=>{O.value=!0;let u=[];for(const w of d.images)if(w){const j=w;u.push($fetch("/api/storage/item",{method:"POST",body:j}))}let I=(await Promise.all(u)).map(w=>w.id),k=await $fetch("/api/images/item",{method:"POST",body:{author_id:d.author.id,local_file_ids:I,urls:d.urls,date:R(d.date),nsfw:d.nsfw}});O.value=!1,o==null||o.value.close(k)});function Z(){a.open(at,{props:{header:"添加作者",modal:!0,style:{width:"50rem",maxWidth:"100vw"}},onClose:d=>{(d==null?void 0:d.type)==="config-close"&&$()}})}return(d,u)=>{var c,y;const I=ue,k=Xe,w=fe,j=ce,ee=$e,B=Ye,z=de;return T(),M("form",{onSubmit:u[4]||(u[4]=(...f)=>t(W)&&t(W)(...f)),class:"flex flex:col gap:16"},[m("div",dt,[ft,s(I,K({"input-id":"date",modelValue:t(_),"onUpdate:modelValue":u[0]||(u[0]=f=>F(_)?_.value=f:null)},t(x),{"input-class":{"p-invalid":t(i).date},"date-format":"yy-mm-dd",class:"w:full"}),null,16,["modelValue","input-class"]),m("small",mt,A(t(i).date),1)]),m("div",pt,[_t,m("div",ht,[s(k,K({modelValue:t(C),"onUpdate:modelValue":u[1]||(u[1]=f=>F(C)?C.value=f:null)},t(g),{"option-label":"name","input-id":"author",placeholder:"输入名称查找作者",suggestions:t(D),loading:t(v),disabled:t(v),"input-class":["w:full",{"p-invalid":t(i).author}],class:"flex-grow:1",onComplete:G}),null,16,["modelValue","suggestions","loading","disabled","input-class"]),s(w,{onClick:Z,icon:"pi pi-plus"})]),m("small",vt,A(t(i).author),1)]),m("div",gt,[wt,s(B,K({modelValue:t(L),"onUpdate:modelValue":u[2]||(u[2]=f=>F(L)?L.value=f:null)},t(X),{placeholder:"输入网址后按回车添加","input-id":"urls",class:{"p-invalid":t(i).urls},pt:{container:{class:"w:full"}}}),{chip:h(f=>[s(ee,{url:f.value},{default:h(E=>[m("div",yt,[s(j,null,{default:h(()=>[m("img",{src:t(He)(f.value)??"favicon.ico",alt:"favicon",class:"h:16 aspect:1/1 mr:2"},null,8,bt),he(" "+A(E.socialPostType.key),1)]),_:2},1024),m("span",null,A(E.socialPostType.toDisplay()||f.value),1)])]),_:2},1032,["url"])]),_:1},16,["modelValue","class"]),m("small",xt,A(t(i).urls),1)]),m("div",kt,[$t,s(z,K({"input-id":"nsfw",modelValue:t(N),"onUpdate:modelValue":u[3]||(u[3]=f=>F(N)?N.value=f:null)},t(Y),{"input-class":{"p-invalid":t(i).nsfw},binary:!0}),null,16,["modelValue","input-class"]),m("small",Ct,A(t(i).nsfw),1)]),m("div",St,[s(w,{onClick:V,label:"上传图片",icon:"pi pi-plus",class:"as:start",badge:(c=t(S))==null?void 0:c.length.toString()},null,8,["badge"]),(y=t(S))!=null&&y.length?(T(),M("div",Vt,[(T(!0),M(je,null,Fe(t(S),(f,E)=>(T(),qe(t(nt),{key:E,object:f},{default:h(ye=>[m("div",{class:"h:full r:6 aspect:1/1 bg:center bg:cover shadow-2 image-container",style:Me(`background-image: url(${ye.value})`)},[m("div",It,[s(w,{onClick:Tt=>J(E),icon:"pi pi-trash",severity:"danger",text:"",rounded:"",size:"small",class:"abs top:10 right:10 bg:white"},null,8,["onClick"])])],4)]),_:2},1032,["object"]))),128))])):ve("",!0),m("small",Dt,A(t(i).images),1)]),s(w,{type:"submit",label:"添加",loading:t(O)},null,8,["loading"])],32)}}});const At=ze(Et,[["__scopeId","data-v-1bd36ffc"]]),Ut={class:"h:full flex flex:column"},Lt=m("label",{for:"nsfw"},"是否为NSFW",-1),Vo=ae({__name:"images",setup(e){const a=[{field:"id",order:-1}],o=U({id:{value:null,matchMode:te.EQUALS},date:{value:null,matchMode:te.EQUALS},nsfw:{value:null,matchMode:te.EQUALS}}),{t:l}=Ke(),v=Pe(),p=Qe(),$=_e(),i=U(!1),r=U({offset:0,limit:20,order_by:P(a)}),b=U([{label:"添加条目",icon:"pi pi-plus",command:S},{label:"刷新",icon:"pi pi-refresh",command:()=>g()}]),{data:_,pending:x,error:C,execute:g}=ge("/api/images/item",{query:r,server:!1},"$aIUgAkptOX");function L(n){v.require({message:"你是否确定要删除？",header:"确认删除",icon:"pi pi-info-circle",acceptClass:"p-button-danger p-button-text",rejectClass:"p-button",accept:()=>{i.value=!0,$fetch.raw(`/api/images/item/${n}`,{method:"DELETE",ignoreResponseError:!0}).then(D=>{switch(D.status){case 200:g(),p.add({severity:"info",summary:l("shared.confirmed"),detail:l("messages.itemDeleted"),life:3e3});break;case 403:p.add({severity:"error",summary:l("shared.error"),detail:l("requestErrors.status.403"),life:3e3});break;case 404:p.add({severity:"error",summary:l("shared.error"),detail:l("requestErrors.status.404"),life:3e3});break;default:p.add({severity:"error",summary:l("shared.error"),detail:l("requestErrors.network"),life:3e3});break}}).catch(()=>{p.add({severity:"error",summary:l("shared.error"),detail:l("requestErrors.network"),life:3e3})}).finally(()=>{i.value=!1})}})}function X(n){r.value={...r.value,offset:n.first,order_by:P(n.multiSortMeta??a),id:n.filters.id.value??void 0,date:R(n.filters.date.value)??void 0,nsfw:n.filters.nsfw.value??void 0},g()}function N(n){console.log(n),r.value={...r.value,offset:n.first,order_by:P(n.multiSortMeta??a),id:n.filters.id.value??void 0,date:R(n.filters.date.value)??void 0,nsfw:n.filters.nsfw.value??void 0},g()}function Y(n){console.log(n),r.value={...r.value,offset:n.first,order_by:P(n.multiSortMeta??a),id:n.filters.id.value??void 0,date:R(n.filters.date.value)??void 0,nsfw:n.filters.nsfw.value??void 0}}function S(){$.open(At,{props:{header:"添加条目",modal:!0,style:{width:"50rem",maxWidth:"100vw"}},onClose:n=>{(n==null?void 0:n.type)==="config-close"&&g()}})}return(n,D)=>{var B,z;const O=be,G=xe,V=ke,J=ce,W=Ce,Z=ue,d=de,u=Se,I=fe,k=Ve,w=Ie,j=De,ee=Ee;return T(),M("div",Ut,[s(O,{model:t(b),pt:{root:{class:"border:none"}}},null,8,["model"]),s(k,{value:((B=t(_))==null?void 0:B.items)??[],first:t(r).offset,rows:t(r).limit,loading:t(x),"total-records":((z=t(_))==null?void 0:z.count)??0,"multi-sort-meta":a,"sort-mode":"multiple",filters:t(o),"onUpdate:filters":D[0]||(D[0]=c=>F(o)?o.value=c:null),globalFilterFields:["id","date","nsfw"],filterDisplay:"menu","data-key":"id",lazy:"",paginator:"",onPage:X,onSort:N,onFilter:Y,class:"flex-grow:1"},{default:h(()=>[s(V,{field:"id",header:"ID","show-filter-match-modes":!1,sortable:""},{filter:h(({filterModel:c,filterCallback:y})=>[s(G,{modelValue:c.value,"onUpdate:modelValue":f=>c.value=f,onKeydown:re(f=>y(),["enter"]),useGrouping:!1,class:"p-column-filter",placeholder:"检索ID"},null,8,["modelValue","onUpdate:modelValue","onKeydown"])]),_:1}),s(V,{header:"图片数量"},{body:h(c=>[he(A(c.data.local_files.length),1)]),_:1}),s(V,{header:"预览"},{body:h(c=>[c.data.local_files.length?(T(),M("div",{key:0,class:Re(`aspect:1/1 w:6rem shadow-2 r:6 bg:center bg:cover bg:url('https://object.wakachika.love/${c.data.local_files[0].path}')`)},null,2)):ve("",!0)]),_:1}),s(V,{field:"author_id",header:"作者"},{body:h(c=>[s(W,{author:c.data.author},{default:h(y=>[s(J,{class:"cursor:pointer",value:c.data.author.name,onClick:f=>{var E;return(E=y.op)==null?void 0:E.show(f)}},null,8,["value","onClick"])]),_:2},1032,["author"])]),_:1}),s(V,{field:"date",header:"日期","show-filter-match-modes":!1,sortable:""},{filter:h(({filterModel:c,filterCallback:y})=>[s(Z,{modelValue:c.value,"onUpdate:modelValue":f=>c.value=f,onKeydown:re(f=>y(),["enter"]),"date-format":"yy-mm-dd",class:"p-column-filter",placeholder:"检索日期"},null,8,["modelValue","onUpdate:modelValue","onKeydown"])]),_:1}),s(V,{field:"nsfw",header:"NSFW","show-filter-match-modes":!1,sortable:""},{body:h(c=>[s(d,{"model-value":c.data.nsfw,binary:!0,readonly:""},null,8,["model-value"])]),filter:h(({filterModel:c})=>[m("div",null,[s(u,{id:"nsfw",modelValue:c.value,"onUpdate:modelValue":y=>c.value=y,class:"p-column-filter"},null,8,["modelValue","onUpdate:modelValue"]),Lt])]),_:1}),s(V,{header:"操作"},{body:h(c=>[s(I,{onClick:y=>L(c.data.id),icon:"pi pi-trash",size:"small",severity:"danger",loading:t(i),text:""},null,8,["onClick","loading"])]),_:1})]),_:1},8,["value","first","rows","loading","total-records","filters"]),s(w),s(j),s(ee)])}}});export{Vo as default};
